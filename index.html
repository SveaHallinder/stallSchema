<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stall Schema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-header">
        <h1>Stallschema</h1>
    </div>

    <div class="schema-toggle">
        <button class="schema-tab active" id="tab-stable">Stallschema</button>
        <button class="schema-tab" id="tab-ride">Ridschema</button>
    </div>

    <div class="legend">
            <div class="legend-item">
                <div class="legend-missing-feed"></div>
                <span><span style="color: var(--weekend-color);">⚠ Fodring</span></span>
            </div>
            <div class="legend-item">
                <div class="legend-icon"><i class="fas fa-broom" style="color: var(--blue-color);"></i></div>
                <span>Städvecka</span>
            </div>
            <div class="legend-item">
                <div class="red-border"></div>
                <span>IB Bortrest</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon"><i class="fas fa-suitcase" style="color: var(--orange-color);"></i></div>
                <span>Mats Bortrest</span>
            </div>
            <div class="legend-item" style="border: 2px solid var(--primary-color); padding: 2px 8px; margin-left: auto; border-radius: 4px; display: none;">
                <span>Idag</span>
            </div>
        </div>

    <div class="month-nav">
        <button class="nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i></button>
        <div class="month-display" id="month-display">Februari 2025</div>
        <button class="nav-btn" id="next-month"><i class="fas fa-chevron-right"></i></button>
    </div>
    
    <div class="calendar" id="calendar">
        <!-- Calendar content will be dynamically generated here -->
    </div>
    
    <div class="data-controls">
        <button id="print-btn" class="nav-btn" title="Skriv ut schema"><i class="fas fa-print"></i></button>
        <button id="manage-horses-btn" class="button-secondary compact manage-horses hidden">Lägg till / hantera hästar</button>
    </div>
    
    <div id="success-message" class="success-message"></div>
    
    <div class="session-notice">
        <i class="fas fa-info-circle"></i>
        Schemaläggningen sparas automatiskt i din webbläsare.
    </div>

    <button class="floating-today-btn" id="scroll-to-today" aria-label="Hoppa till dagens datum">
        <i class="fas fa-arrow-up"></i>
        <span>Idag</span>
    </button>
    
    <!-- Modal för Dagstatus -->
    <div class="modal" id="day-status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Uppdatera Dagstatus</h2>              
                <span class="close" id="close-day-status-modal">&times;</span>
            </div>
            <span id="selected-day-status-date" class="selected-date"></span>
            
            <form id="day-status-form">
                <div style="margin-top: 20px;">
                    <div class="marker-container">
                        <input type="checkbox" id="ib-away">
                        <div class="marker-label">
                            <div class="marker-icon-wrapper">
                                <span style="border: 1px solid var(--weekend-color); width: 14px; height: 14px; display: block; border-radius: 50%;"></span>
                                <label for="ib-away" style="margin: 0;">IB Bortrest</label>
                            </div>
                        </div>
                    </div>

                    <div class="marker-container">
                        <input type="checkbox" id="cleaning-week">
                        <div class="marker-label">
                            <div class="marker-icon-wrapper">
                                <i class="fas fa-broom" style="color: var(--blue-color);"></i>
                                <label for="cleaning-week" style="margin: 0;">Städvecka</label>
                            </div>
                        </div>
                    </div>

                    <div class="marker-container">
                        <input type="checkbox" id="mats-away">
                        <div class="marker-label">
                            <div class="marker-icon-wrapper">
                                <i class="fas fa-suitcase" style="color: var(--orange-color);"></i>
                                <label for="mats-away" style="margin: 0;">Mats Bortrest</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="button-secondary" id="cancel-day-status">Avbryt</button>
                    <button type="submit">Spara</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal för Skift och Fodring -->
    <div class="modal" id="shift-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lägg in pass</h2>              
                <span class="close" id="close-shift-modal">&times;</span>
            </div>
            <div class="modal-nav">
                <button class="nav-btn" id="prev-day-shift"><i class="fas fa-chevron-left"></i></button>
                <span id="selected-shift-date" class="selected-date"></span>
                <button class="nav-btn" id="next-day-shift"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <form id="shift-form">
                <div>
                    <label for="shift-type">Vilket pass:</label>
                    <select id="shift-type">
                        <option value="morning">Morgon</option>
                        <option value="lunch">Lunch</option>
                        <option value="evening">Kväll</option>
                    </select>
                </div>
                
                <div>
                    <label for="shift-name">Vem tar passet:</label>
                    <input type="text" id="shift-name" placeholder="Skriv namn...">
                </div>
                
                <div class="marker-container">
                    <input type="checkbox" id="missing-feed">
                    <div class="marker-label">
                        <div class="marker-icon-wrapper">
                            <div style="width: 14px; height: 14px; background-color: rgba(244, 67, 54, 0.05); border-left: 2px solid var(--weekend-color); display: inline-block; margin: 0;"></div>
                            <label for="missing-feed" style="margin: 0;"><span style="color: var(--weekend-color); display: flex; align-items: center;">⚠ Fodring</span></label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="button-secondary" id="cancel-shift">Avbryt</button>
                    <button type="submit">Spara</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal för Hästar och standardpass -->
    <div class="modal" id="horse-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hästar & standardpass</h2>              
                <span class="close" id="close-horse-modal">&times;</span>
            </div>
            <div class="modal-section">
                <h3>Lägg till häst</h3>
                <div class="form-inline">
                    <input type="text" id="horse-name-input" placeholder="Hästens namn">
                    <button id="add-horse-btn">Spara häst</button>
                </div>
                <div id="horse-list" class="item-list"></div>
            </div>
            <div class="modal-section">
                <h3>Standardpass</h3>
                <div class="form-grid">
                    <select id="default-horse-select"></select>
                    <select id="default-day-select">
                        <option value="1">Mån</option>
                        <option value="2">Tis</option>
                        <option value="3">Ons</option>
                        <option value="4">Tors</option>
                        <option value="5">Fre</option>
                        <option value="6">Lör</option>
                        <option value="0">Sön</option>
                    </select>
                    <select id="default-slot-select">
                        <option value="morning">Morgon</option>
                        <option value="evening">Kväll</option>
                    </select>
                    <input type="text" id="default-rider-input" placeholder="Ryttare">
                    <button id="add-default-ride-btn">Lägg till/uppdatera</button>
                </div>
                <div id="default-ride-list" class="item-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal för ridpass/avvikelser -->
    <div class="modal" id="ride-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ridpass</h2>              
                <span class="close" id="close-ride-modal">&times;</span>
            </div>
            <span id="selected-ride-date" class="selected-date"></span>

            <form id="ride-form">
                <div class="form-grid">
                    <select id="ride-horse-select"></select>
                    <select id="ride-slot-select">
                        <option value="morning">Morgon</option>
                        <option value="evening">Kväll</option>
                    </select>
                </div>
                <div>
                    <label for="ride-rider-input">Vem rider?</label>
                    <input type="text" id="ride-rider-input" placeholder="Ryttare">
                </div>
                <div class="marker-container">
                    <input type="checkbox" id="ride-away-checkbox">
                    <div class="marker-label">
                        <div class="marker-icon-wrapper">
                            <i class="fas fa-plane-departure" style="color: var(--weekend-color);"></i>
                            <label for="ride-away-checkbox" style="margin: 0;">Bortrest / kommer inte</label>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 30px; display: flex; justify-content: space-between; gap: 12px;">
                    <button type="button" class="button-secondary" id="delete-ride-override">Ta bort avvikelse</button>
                    <div style="display:flex; gap:12px;">
                        <button type="button" class="button-secondary" id="cancel-ride">Avbryt</button>
                        <button type="submit">Spara</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js';
    
        const SUPABASE_URL = 'https://ypiepkfvogxlupsuwnnq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwaWVwa2Z2b2d4bHVwc3V3bm5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTk3MzIsImV4cCI6MjA3OTgzNTczMn0.nd0UMqCE4CXZEg-Pn8sdQReI7EsRNdT_GGWmz4Tp34Y';
    
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
        // DOM elements
        const calendar = document.getElementById('calendar');
        const monthDisplay = document.getElementById('month-display');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const dayStatusModal = document.getElementById('day-status-modal');
        const shiftModal = document.getElementById('shift-modal');
        const horseModal = document.getElementById('horse-modal');
        const rideModal = document.getElementById('ride-modal');
        const dayStatusForm = document.getElementById('day-status-form');
        const shiftForm = document.getElementById('shift-form');
        const importFile = document.getElementById('import-file');
        const scrollToTodayBtn = document.getElementById('scroll-to-today');
        const shiftNameInput = document.getElementById('shift-name');
        const missingFeedCheckbox = document.getElementById('missing-feed');
        const tabStable = document.getElementById('tab-stable');
        const tabRide = document.getElementById('tab-ride');
        const manageHorsesBtn = document.getElementById('manage-horses-btn');
        const horseNameInput = document.getElementById('horse-name-input');
        const horseList = document.getElementById('horse-list');
        const addHorseBtn = document.getElementById('add-horse-btn');
        const defaultHorseSelect = document.getElementById('default-horse-select');
        const defaultDaySelect = document.getElementById('default-day-select');
        const defaultSlotSelect = document.getElementById('default-slot-select');
        const defaultRiderInput = document.getElementById('default-rider-input');
        const addDefaultRideBtn = document.getElementById('add-default-ride-btn');
        const defaultRideList = document.getElementById('default-ride-list');
        const closeHorseModal = document.getElementById('close-horse-modal');
        const rideHorseSelect = document.getElementById('ride-horse-select');
        const rideSlotSelect = document.getElementById('ride-slot-select');
        const rideRiderInput = document.getElementById('ride-rider-input');
        const rideAwayCheckbox = document.getElementById('ride-away-checkbox');
        const selectedRideDateEl = document.getElementById('selected-ride-date');
        const rideForm = document.getElementById('ride-form');
        const deleteRideOverrideBtn = document.getElementById('delete-ride-override');
        const cancelRideBtn = document.getElementById('cancel-ride');
        const closeRideModal = document.getElementById('close-ride-modal');
        const successMessage = document.getElementById('success-message');
        const cancelDayStatus = document.getElementById('cancel-day-status');
        const cancelShift = document.getElementById('cancel-shift');
        const printBtn = document.getElementById('print-btn');
        const prevDayShiftBtn = document.getElementById('prev-day-shift');
        const nextDayShiftBtn = document.getElementById('next-day-shift');
    
        // Translations - Define both day name arrays
        const dayNamesSundayStart = ['Sön', 'Mån', 'Tis', 'Ons', 'Tors', 'Fre', 'Lör'];
        const dayNamesMondayStart = ['Mån', 'Tis', 'Ons', 'Tors', 'Fre', 'Lör', 'Sön'];
        const monthNames = ['Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 
                           'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
        const shiftNames = {
            'morning': 'Morgon',
            'lunch': 'Lunch',
            'evening': 'Kväll'
        };
        
        // Function to determine if we're in mobile view
        function isMobileView() {
            return window.innerWidth <= 767;
        }
        
        // Function to get appropriate day names based on view
        function getDayNames() {
            return isMobileView() ? dayNamesSundayStart : dayNamesMondayStart;
        }
        
        // Special days data (could be expanded)
        const specialDays = {
            '2024-03-29': 'Långfredagen',
            '2024-03-31': 'Påskdagen'
        };
        
        // Current date tracking
        let currentDate = new Date(new Date().toLocaleDateString('sv-SE'));
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let currentMode = 'stable'; // stable | ride
        
        // Schedule data containers
        let scheduleData = {};
        let specialEvents = {};
        let horses = [];
        let rideDefaults = [];
        let rideOverrides = [];
        let selectedRideDate = '';
        
        // Selected date for the modal
        let selectedDateStr = '';
    
        // Open Day Status Modal (three dots)
        function openDayStatusModal(date) {
            document.getElementById("selected-day-status-date").textContent = formatDisplayDate(date);
            dayStatusModal.dataset.date = date;
            dayStatusModal.style.display = "block";
            fetchDayStatus(date);
        }
    
        function openShiftModal(date, shiftType = "morning") {
            selectedDateStr = date;
            document.getElementById("selected-shift-date").textContent = formatDisplayDate(date);
            document.getElementById("shift-modal").dataset.date = date;
            
            // Validera shift type
            const validShiftTypes = ["morning", "lunch", "evening"];
            if (validShiftTypes.includes(shiftType)) {
                document.getElementById("shift-type").value = shiftType;
            } else {
                // Sätt default till morgon om ogiltig
                document.getElementById("shift-type").value = "morning";
                console.warn("Korrigerade ogiltig shift type:", shiftType);
            }

            // Rensa fälten först
            shiftNameInput.value = "";
            missingFeedCheckbox.checked = false;
            syncMissingFeedState();

            // Hämta befintliga skift för att fylla i om det redan finns något sparat
            fetchShifts(date);

            document.getElementById("shift-modal").style.display = "block";
        }

        // Force fodring to only be used when no one is assigned
        function syncMissingFeedState() {
            const hasName = shiftNameInput.value.trim().length > 0;
            if (hasName) {
                missingFeedCheckbox.checked = false;
                missingFeedCheckbox.disabled = true;
                missingFeedCheckbox.title = "Fodring saknas används bara när inget pass är tillsatt";
            } else {
                missingFeedCheckbox.disabled = false;
                missingFeedCheckbox.title = "";
            }
        }

        // Mode handling
        function setMode(mode) {
            currentMode = mode;
            if (mode === 'ride') {
                tabRide.classList.add('active');
                tabStable.classList.remove('active');
                manageHorsesBtn.classList.remove('hidden');
                fetchRideData();
            } else {
                tabStable.classList.add('active');
                tabRide.classList.remove('active');
                manageHorsesBtn.classList.add('hidden');
                fetchSchedule();
            }
            renderCalendar(currentMonth, currentYear);
        }

        // Format date for display (e.g., "25 februari 2025")
        function formatDisplayDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            const monthName = monthNames[parseInt(month) - 1];
            return `${parseInt(day)} ${monthName} ${year}`;
        }
    
        // Close modals
        document.getElementById("close-day-status-modal").addEventListener("click", () => {
            dayStatusModal.style.display = "none";
        });
        
        document.getElementById("close-shift-modal").addEventListener("click", () => {
            shiftModal.style.display = "none";
        });
        
        cancelDayStatus.addEventListener("click", () => {
            dayStatusModal.style.display = "none";
        });
        
        cancelShift.addEventListener("click", () => {
            shiftModal.style.display = "none";
        });

        // Day navigation in shift modal
        prevDayShiftBtn.addEventListener("click", () => {
            navigateShiftDay(-1);
        });

        nextDayShiftBtn.addEventListener("click", () => {
            navigateShiftDay(1);
        });

        function navigateShiftDay(offset) {
            const currentDate = new Date(selectedDateStr);
            currentDate.setDate(currentDate.getDate() + offset);
            const newDateStr = formatDateStr(
                currentDate.getFullYear(),
                currentDate.getMonth(),
                currentDate.getDate()
            );
            
            // Save current form data if needed
            const shiftType = document.getElementById("shift-type").value;
            
            // Update modal with new date
            selectedDateStr = newDateStr;
            openShiftModal(newDateStr, shiftType);
        }
    
        // Get day status from Supabase
        async function fetchDayStatus(date) {
            const { data, error } = await supabase
                .from('schedule_day_status')
                .select('*')
                .eq('date', date);
    
            if (error) {
                console.error("Error fetching day status:", error);
                return;
            }
    
            const dayStatus = data.length > 0 ? data[0] : null;
            document.getElementById("ib-away").checked = dayStatus?.ib_away || false;
            document.getElementById("cleaning-week").checked = dayStatus?.cleaning_week || false;
            document.getElementById("mats-away").checked = dayStatus?.mats_away || false;
        }

        shiftNameInput.addEventListener("input", syncMissingFeedState);

        async function fetchShifts(date) {
            const { data, error } = await supabase
                .from('schedule_shifts')
                .select('*')
                .eq('date', date);

            if (error) {
                console.error("Error fetching shifts:", error);
                return;
            }

            // Reset fields when modal opens
            shiftNameInput.value = "";
            missingFeedCheckbox.checked = false;
            syncMissingFeedState();

            // Hämta valt skift från dropdown
            let shiftDropdown = document.getElementById("shift-type");
            let shiftType = shiftDropdown.value;
            let shift = data.find(s => s.shift === shiftType);

            const applyShiftToForm = (shiftRecord) => {
                const hasName = Boolean(shiftRecord?.name?.trim());
                shiftNameInput.value = hasName ? shiftRecord.name.trim() : "";
                missingFeedCheckbox.checked = hasName ? false : (shiftRecord?.missing_feed || false);
                syncMissingFeedState();
            };

            applyShiftToForm(shift);

            // Lägg till event listener på dropdown
            shiftDropdown.onchange = function () {
                let newShiftType = this.value;
                let newShift = data.find(s => s.shift === newShiftType);
                applyShiftToForm(newShift);
            };
        }

        // Daystate form handler
        dayStatusForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const date = dayStatusModal.dataset.date;
            const ibAway = document.getElementById("ib-away").checked;
            const cleaningWeek = document.getElementById("cleaning-week").checked;
            const matsAway = document.getElementById("mats-away").checked;

            const { error } = await supabase
                .from('schedule_day_status')
                .upsert([{ 
                    date, 
                    ib_away: ibAway, 
                    cleaning_week: cleaningWeek, 
                    mats_away: matsAway 
                }], { onConflict: ['date'] });

            if (error) {
                console.error("Error saving day status:", error);
                showSuccessMessage('Fel vid sparande: ' + error.message, 'error');
            } else {
                dayStatusModal.style.display = "none";
                fetchSchedule();
                showSuccessMessage('Status sparad');
            }
        });

    
        // Save Shift utan onConflict
        shiftForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const date = shiftModal.dataset.date;
            const name = shiftNameInput.value.trim();
            const missingFeed = name.length === 0 && missingFeedCheckbox.checked;
            const shiftType = document.getElementById("shift-type").value;

            // Validera shift type
            if (!["morning", "lunch", "evening"].includes(shiftType)) {
                console.error("Invalid shift type:", shiftType);
                showSuccessMessage('Fel: Ogiltigt skifttyp', 'error');
                return;
            }

            try {
                // Kontrollera först om det finns en befintlig post
                const { data: existingData, error: fetchError } = await supabase
                    .from('schedule_shifts')
                    .select('id')
                    .eq('date', date)
                    .eq('shift', shiftType);

                if (fetchError) {
                    console.error("Error checking existing shift:", fetchError);
                    showSuccessMessage('Fel vid kontroll av befintligt pass', 'error');
                    return;
                }

                let result;
                
                if (existingData && existingData.length > 0) {
                    // Om posten finns, uppdatera den
                    const id = existingData[0].id;
                    result = await supabase
                        .from('schedule_shifts')
                        .update({ 
                            name, 
                            missing_feed: missingFeed 
                        })
                        .eq('id', id);
                } else {
                    // Om posten inte finns, skapa en ny
                    result = await supabase
                        .from('schedule_shifts')
                        .insert([{ 
                            date, 
                            shift: shiftType, 
                            name, 
                            missing_feed: missingFeed 
                        }]);
                }

                if (result.error) {
                    console.error("Error saving shift:", result.error);
                    showSuccessMessage('Fel vid sparande: ' + result.error.message, 'error');
                } else {
                    shiftModal.style.display = "none";
                    fetchSchedule();
                    showSuccessMessage('Pass sparat');
                }
            } catch (e) {
                console.error("Exception saving shift:", e);
                showSuccessMessage('Ett fel uppstod', 'error');
            }
        });
    
        // Main function to fetch and render the schedule
        async function fetchSchedule() {
            // Show loading indicator
            showSuccessMessage('Laddar schema...', 'loading');
            
            // Fetch day status
            const { data: dayStatus, error: dayStatusError } = await supabase
                .from('schedule_day_status')
                .select('*');
    
            if (dayStatusError) {
                console.error("Error fetching day status:", dayStatusError);
                showSuccessMessage('Fel vid hämtning av dagstatus', 'error');
                return;
            }
    
            // Fetch shifts
            const { data: shifts, error: shiftsError } = await supabase
                .from('schedule_shifts')
                .select('*');
    
            if (shiftsError) {
                console.error("Error fetching shifts:", shiftsError);
                showSuccessMessage('Fel vid hämtning av pass', 'error');
                return;
            }
    
            // Reset schedule data
            scheduleData = {};
            specialEvents = {};
    
            // Process day status data
            dayStatus.forEach(day => {
                const { date, ib_away, cleaning_week, mats_away } = day;
                specialEvents[date] = { 
                    cleaningWeek: cleaning_week, 
                    ibAway: ib_away, 
                    matsAway: mats_away, 
                    missingFeed: [] 
                };
            });
    
            // Process shift data
            shifts.forEach(shift => {
                const { date, shift: shiftType, name, missing_feed } = shift;
                const hasName = Boolean(name && name.trim());

                if (!scheduleData[date]) {
                    scheduleData[date] = {};
                }
                
                scheduleData[date][shiftType] = hasName ? name.trim() : "Ej tilldelat";

                if (missing_feed && !hasName) {
                    if (!specialEvents[date]) {
                        specialEvents[date] = { cleaningWeek: false, ibAway: false, matsAway: false, missingFeed: [] };
                    }
                    specialEvents[date].missingFeed.push(shiftType);
                }
            });
    
            // Render the calendar with updated data
            renderCalendar(currentMonth, currentYear);
            
            // Hide loading indicator
            successMessage.style.display = 'none';
        }

        // Ride schema data
        async function fetchRideData() {
            showSuccessMessage('Laddar ridschema...', 'loading');
            const { data: horseData, error: horseError } = await supabase
                .from('horses')
                .select('*')
                .eq('archived', false)
                .order('name');

            if (horseError) {
                console.error("Error fetching horses:", horseError);
                showSuccessMessage('Fel vid hämtning av hästar', 'error');
                return;
            }

            const { data: defaultData, error: defaultError } = await supabase
                .from('horse_default_rides')
                .select('*');

            if (defaultError) {
                console.error("Error fetching default rides:", defaultError);
                showSuccessMessage('Fel vid hämtning av standardpass', 'error');
                return;
            }

            const { data: overrideData, error: overrideError } = await supabase
                .from('horse_ride_overrides')
                .select('*');

            if (overrideError) {
                console.error("Error fetching ride overrides:", overrideError);
                showSuccessMessage('Fel vid hämtning av avvikelser', 'error');
                return;
            }

            horses = horseData || [];
            rideDefaults = defaultData || [];
            rideOverrides = overrideData || [];

            populateHorseSelects();
            renderDefaultRideList();
            renderHorseList();
            renderCalendar(currentMonth, currentYear);
            successMessage.style.display = 'none';
        }
    
        // Initialize calendar
        function initCalendar() {
            // Add day headers with the correct day names for current view
            getDayNames().forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                
                // Set weekend styling correctly based on the view
                if ((isMobileView() && (index === 0 || index === 6)) || 
                    (!isMobileView() && (index === 5 || index === 6))) {
                    dayHeader.classList.add('weekend');
                }
                
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Render the calendar
            renderCalendar(currentMonth, currentYear);
        }
        
        function renderCalendar(month, year) {
            // Update month display
            monthDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Clear existing date cells
            const headers = document.querySelectorAll('.day-header');
            calendar.innerHTML = '';
            
            // Get correct day names for current view
            const currentDayNames = getDayNames();
            
            // Add back day headers with correct ordering
            currentDayNames.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                
                // Set weekend styling correctly based on the view
                if ((isMobileView() && (index === 0 || index === 6)) || 
                    (!isMobileView() && (index === 5 || index === 6))) {
                    dayHeader.classList.add('weekend');
                }
                
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Get first day of month
            const firstDay = new Date(year, month, 1).getDay(); // 0 is Sunday, 1 is Monday, etc.
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Adjust first day based on view type
            const adjustedFirstDay = isMobileView() 
                ? firstDay // No adjustment needed for Sunday start
                : (firstDay === 0 ? 6 : firstDay - 1); // Adjust for Monday start
            
            // Add cells for previous month days
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = 0; i < adjustedFirstDay; i++) {
                const day = prevMonthDays - adjustedFirstDay + i + 1;
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                const dateStr = formatDateStr(prevYear, prevMonth, day);
                
                const dayCell = createDayCell(day, dateStr, 'inactive');
                calendar.appendChild(dayCell);
            }
            
            const today = new Date();
            
            // Add cells for current month days
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = formatDateStr(year, month, i);
                const isToday = i === today.getDate() && 
                                month === today.getMonth() && 
                                year === today.getFullYear();
                
                const dayCell = createDayCell(i, dateStr, isToday ? 'today' : '');
                calendar.appendChild(dayCell);
                
                // Add week number (only for desktop view with Monday start)
                if (!isMobileView() && (adjustedFirstDay + i - 1) % 7 === 0) {
                    const weekDate = new Date(year, month, i);
                    const weekNumber = getWeekNumber(weekDate);
                    
                    const weekNumberElement = document.createElement('div');
                    weekNumberElement.className = 'week-number';
                    weekNumberElement.textContent = weekNumber;
                    
                    dayCell.style.position = 'relative';
                    dayCell.appendChild(weekNumberElement);
                }
            }
            
            // Add cells for next month days if needed to fill grid
            const totalCells = Math.ceil((adjustedFirstDay + daysInMonth) / 7) * 7;
            const nextMonthDays = totalCells - (adjustedFirstDay + daysInMonth);
            
            for (let i = 1; i <= nextMonthDays; i++) {
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                const dateStr = formatDateStr(nextYear, nextMonth, i);
                
                const dayCell = createDayCell(i, dateStr, 'inactive');
                calendar.appendChild(dayCell);
            }
        }
        
        function createDayCell(day, dateStr, extraClass = '') {
            const cell = document.createElement('div');
            cell.className = 'date-cell ' + extraClass;
            cell.classList.add('day'); // Add day class for click event
            cell.setAttribute('data-date', dateStr);
            const createMarkerChip = (className, iconHtml, label) => {
                const chip = document.createElement('div');
                chip.className = `marker-chip ${className}`;
                chip.innerHTML = iconHtml;
                chip.title = label;
                chip.setAttribute('aria-label', label);
                return chip;
            };
            
            // Create date object once and use it for both day name and weekend check
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Get the correct day names array based on view
            const currentDayNames = getDayNames();
            
            // Calculate the correct day name index based on view type
            const dayNameIndex = isMobileView() 
                ? dayOfWeek // For mobile (Sunday start): use dayOfWeek directly
                : (dayOfWeek === 0 ? 6 : dayOfWeek - 1); // For desktop (Monday start): adjust
                
            cell.setAttribute('data-day-name', currentDayNames[dayNameIndex]);
            
            // Create top row with date and options
            const topRow = document.createElement('div');
            topRow.className = 'top-row';
            
            // Add date number
            const dateNumber = document.createElement('div');
            dateNumber.className = 'date-number';
            
            // Make weekends red
            if (dayOfWeek === 0 || dayOfWeek === 6) { // 0 is Sunday, 6 is Saturday
                dateNumber.classList.add('weekend-date');
            }
            
            // Make today's date a circle
            if (extraClass.includes('today')) {
                dateNumber.classList.add('today-circle');
            }
            
            dateNumber.textContent = day;
            topRow.appendChild(dateNumber);
            
            // Add options button (three dots)
            const options = document.createElement('span');
            options.className = 'options';
            options.innerHTML = '<i class="fas fa-ellipsis-h"></i>';
            options.onclick = (e) => {
                e.stopPropagation();
                openDayStatusModal(dateStr);
            };
            
            // Inline marker icons (clean & mats)
            const markerInline = document.createElement('div');
            markerInline.className = 'marker-inline';

            const topRight = document.createElement('div');
            topRight.className = 'top-right';
            topRight.appendChild(markerInline);
            topRight.appendChild(options);

            topRow.appendChild(topRight);
            
            cell.appendChild(topRow);
            
            if (specialEvents[dateStr]) {
                const { cleaningWeek, ibAway, matsAway } = specialEvents[dateStr];
                
                if (ibAway) {
                    cell.classList.add('ib-away');
                }

                if (cleaningWeek) {
                    markerInline.appendChild(createMarkerChip('cleaning', '<i class="fas fa-broom"></i>', 'Städvecka'));
                }
                
                if (matsAway) {
                    markerInline.appendChild(createMarkerChip('mats-away', '<i class="fas fa-suitcase"></i>', 'Mats bortrest'));
                }
            }
            
            // Add events container
            const events = document.createElement('div');
            events.className = 'events';
            
            if (currentMode === 'ride') {
                events.classList.add('ride-events');
                const assignments = getRideAssignmentsForDate(dateStr);
                const slots = [
                    { key: 'morning', label: 'Morgon', icon: '<i class="far fa-sun"></i>' },
                    { key: 'evening', label: 'Kväll', icon: '<i class="far fa-moon"></i>' }
                ];

                slots.forEach(slot => {
                    const slotBlock = document.createElement('div');
                    slotBlock.className = 'ride-slot-block';
                    slotBlock.innerHTML = `<div class="ride-slot-label">${slot.icon}<span>${slot.label}</span></div>`;
                    const slotAssignments = assignments.filter(a => a.slot === slot.key);
                    const badgeWrap = document.createElement('div');
                    badgeWrap.className = 'ride-badges';

                    if (!slotAssignments.length) {
                        const empty = document.createElement('div');
                        empty.className = 'empty-event';
                        empty.textContent = 'Ingen rider';
                        badgeWrap.appendChild(empty);
                    } else {
                        slotAssignments.forEach(a => {
                            const badge = document.createElement('div');
                            badge.className = 'ride-badge';
                            if (a.away) badge.classList.add('away');
                            badge.innerHTML = `<span class="horse-name">${a.horseName}</span><span class="rider-name">${a.rider || 'Ej angivet'}</span>`;
                            badge.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openRideModal(dateStr, a.horseId, a.slot);
                            });
                            badgeWrap.appendChild(badge);
                        });
                    }

                    const addBtn = document.createElement('button');
                    addBtn.type = 'button';
                    addBtn.className = 'button-secondary tiny';
                    addBtn.textContent = '+ Lägg till';
                    addBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openRideModal(dateStr, horses[0]?.id || null, slot.key);
                    });

                    slotBlock.appendChild(badgeWrap);
                    slotBlock.appendChild(addBtn);
                    events.appendChild(slotBlock);
                });
                cell.appendChild(events);
            } else {
                // Add shifts
                const shifts = ["morning", "lunch", "evening"];
                const shiftIcons = {
                    "morning": '<i class="far fa-sun" style="width: 16px;"></i>',
                    "lunch": '<i class="far fa-clock" style="width: 16px;"></i>',
                    "evening": '<i class="far fa-moon" style="width: 16px;"></i>'
                };
                
                shifts.forEach(shift => {
                    const event = document.createElement('div');
                    event.className = `event event-${shift}`;
                    event.setAttribute('data-shift-type', shift);
                    const hasAssignee = Boolean(scheduleData[dateStr]?.[shift] && scheduleData[dateStr][shift] !== "Ej tilldelat");
                    const personName = hasAssignee ? scheduleData[dateStr][shift] : "";
                    const isMissingFeed = specialEvents[dateStr]?.missingFeed?.includes(shift);

                    if (hasAssignee) {
                        event.innerHTML = `${shiftIcons[shift]} <span class="person-name">${personName}</span>`;
                    } else if (isMissingFeed) {
                        event.classList.add("missing-feed");
                        event.innerHTML = `${shiftIcons[shift]} <span class="missing-feed-wrapper"><span class="missing-feed-text">⚠ Fodring</span><span class="empty-event" style="margin-left: 6px;">Ej tilldelat</span></span>`;
                    } else {
                        event.innerHTML = `${shiftIcons[shift]} <span class="empty-event">${shiftNames[shift]}</span>`;
                    }
                    
                    // Lägg till klick-hantering för varje pass
                    event.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!cell.classList.contains('inactive')) {
                            openShiftModal(dateStr, shift);
                        }
                    });
                    
                    events.appendChild(event);
                });
                
                cell.appendChild(events);
            }
            
            // Add special day text if applicable
            if (specialDays[dateStr]) {
                const specialDay = document.createElement('div');
                specialDay.className = 'special-day';
                specialDay.textContent = specialDays[dateStr];
                cell.appendChild(specialDay);
            }

            // Add click handler to open shift modal
            cell.addEventListener('click', () => {
                if (!cell.classList.contains('inactive')) {
                    if (currentMode === 'ride') {
                        openRideModal(dateStr, horses[0]?.id || null);
                    } else {
                        openShiftModal(dateStr);
                    }
                }
            });
            
            return cell;
        }
        
        // Format date as YYYY-MM-DD
        function formatDateStr(year, month, day) {
            return `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
        
        // Get week number for a date
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            // Return week number
            return weekNo;
        }

        function getRideAssignmentsForDate(dateStr) {
            const day = new Date(dateStr).getDay();
            const horseMap = Object.fromEntries(horses.map(h => [h.id, h]));
            const byKey = {};

            rideDefaults.forEach(item => {
                if (item.day_of_week !== day) return;
                const horse = horseMap[item.horse_id];
                if (!horse) return;
                const key = `${item.horse_id}_${item.slot}`;
                byKey[key] = {
                    horseId: item.horse_id,
                    horseName: horse.name,
                    slot: item.slot,
                    rider: item.rider_name || '',
                    away: false,
                    source: 'default'
                };
            });

            rideOverrides.forEach(item => {
                if (item.date !== dateStr) return;
                const horse = horseMap[item.horse_id];
                if (!horse) return;
                const key = `${item.horse_id}_${item.slot}`;
                const fallback = byKey[key]?.rider || '';
                byKey[key] = {
                    horseId: item.horse_id,
                    horseName: horse.name,
                    slot: item.slot,
                    rider: item.rider_name || fallback,
                    away: item.away,
                    source: 'override'
                };
            });

            return Object.values(byKey);
        }
        
        // Print function
        function printSchedule() {
            window.print();
        }
        
        
        // Show success message
        function showSuccessMessage(message, type = 'success') {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            
            if (type === 'error') {
                successMessage.style.color = '#f44336';
            } else if (type === 'loading') {
                successMessage.style.color = '#2196f3';
            } else {
                successMessage.style.color = '#212121';
            }
            
            if (type !== 'loading') {
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 2000);
            }
        }

        function populateHorseSelects() {
            if (!horses) return;
            const options = horses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
            if (defaultHorseSelect) defaultHorseSelect.innerHTML = options;
            if (rideHorseSelect) rideHorseSelect.innerHTML = options;
        }

        function renderHorseList() {
            if (!horseList) return;
            horseList.innerHTML = '';
            if (!horses.length) {
                horseList.innerHTML = '<div class="empty-state">Inga hästar ännu</div>';
                return;
            }
            horses.forEach(horse => {
                const row = document.createElement('div');
                row.className = 'list-row';
                row.innerHTML = `<span>${horse.name}</span>`;
                const actions = document.createElement('div');
                actions.className = 'list-actions';
                const archiveBtn = document.createElement('button');
                archiveBtn.className = 'button-secondary compact';
                archiveBtn.textContent = 'Ta bort';
                archiveBtn.onclick = () => archiveHorse(horse.id);
                actions.appendChild(archiveBtn);
                row.appendChild(actions);
                horseList.appendChild(row);
            });
        }

        function renderDefaultRideList() {
            if (!defaultRideList) return;
            defaultRideList.innerHTML = '';
            if (!rideDefaults.length) {
                defaultRideList.innerHTML = '<div class="empty-state">Inga standardpass ännu</div>';
                return;
            }
            const horseMap = Object.fromEntries(horses.map(h => [h.id, h.name]));
            const dayNames = ['Sön','Mån','Tis','Ons','Tors','Fre','Lör'];
            rideDefaults.forEach(item => {
                const row = document.createElement('div');
                row.className = 'list-row';
                row.innerHTML = `<span><strong>${horseMap[item.horse_id] || 'Häst'}</strong> • ${dayNames[item.day_of_week]} • ${item.slot === 'morning' ? 'Morgon' : 'Kväll'} • ${item.rider_name || 'Ej angivet'}</span>`;
                const actions = document.createElement('div');
                actions.className = 'list-actions';
                const delBtn = document.createElement('button');
                delBtn.className = 'button-secondary compact';
                delBtn.textContent = 'Ta bort';
                delBtn.onclick = () => deleteDefaultRide(item.id);
                actions.appendChild(delBtn);
                row.appendChild(actions);
                defaultRideList.appendChild(row);
            });
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === dayStatusModal) {
                dayStatusModal.style.display = 'none';
            }
            if (e.target === shiftModal) {
                shiftModal.style.display = 'none';
            }
            if (e.target === horseModal) {
                horseModal.style.display = 'none';
            }
            if (e.target === rideModal) {
                rideModal.style.display = 'none';
            }
        });
        
        // Add resize event listener to handle view changes
        window.addEventListener('resize', () => {
            renderCalendar(currentMonth, currentYear);
        });

        async function addHorse() {
            const name = horseNameInput.value.trim();
            if (!name) return;
            const { error } = await supabase.from('horses').insert([{ name }]);
            if (error) {
                console.error('Error adding horse', error);
                showSuccessMessage('Kunde inte spara häst', 'error');
                return;
            }
            horseNameInput.value = '';
            fetchRideData();
        }

        async function archiveHorse(id) {
            const { error } = await supabase.from('horses').update({ archived: true }).eq('id', id);
            if (error) {
                console.error('Error archiving horse', error);
                showSuccessMessage('Kunde inte ta bort häst', 'error');
                return;
            }
            fetchRideData();
        }

        async function addDefaultRide() {
            const horseId = defaultHorseSelect.value;
            const day = parseInt(defaultDaySelect.value, 10);
            const slot = defaultSlotSelect.value;
            const rider = defaultRiderInput.value.trim();
            if (!horseId || !slot) return;
            const { error } = await supabase
                .from('horse_default_rides')
                .upsert([{ horse_id: horseId, day_of_week: day, slot, rider_name: rider }], { onConflict: ['horse_id', 'day_of_week', 'slot'] });
            if (error) {
                console.error('Error saving default ride', error);
                showSuccessMessage('Kunde inte spara standardpass', 'error');
                return;
            }
            defaultRiderInput.value = '';
            fetchRideData();
        }

        async function deleteDefaultRide(id) {
            const { error } = await supabase.from('horse_default_rides').delete().eq('id', id);
            if (error) {
                console.error('Error deleting default ride', error);
                showSuccessMessage('Kunde inte ta bort standardpass', 'error');
                return;
            }
            fetchRideData();
        }

        // Manual jump to today to avoid unexpected auto-scrolls
        function scrollToToday() {
            currentMonth = currentDate.getMonth();
            currentYear = currentDate.getFullYear();
            renderCalendar(currentMonth, currentYear);

            setTimeout(() => {
                const todayElement = document.querySelector('.date-cell.today');
                if (todayElement) {
                    todayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        if (scrollToTodayBtn) {
            scrollToTodayBtn.addEventListener('click', scrollToToday);
        }

        tabStable.addEventListener('click', () => setMode('stable'));
        tabRide.addEventListener('click', () => setMode('ride'));
        if (manageHorsesBtn) manageHorsesBtn.addEventListener('click', () => {
            populateHorseSelects();
            renderHorseList();
            renderDefaultRideList();
            horseModal.style.display = 'block';
        });
        addHorseBtn?.addEventListener('click', addHorse);
        addDefaultRideBtn?.addEventListener('click', addDefaultRide);
        closeHorseModal?.addEventListener('click', () => horseModal.style.display = 'none');
        rideForm?.addEventListener('submit', saveRideOverride);
        deleteRideOverrideBtn?.addEventListener('click', deleteRideOverride);
        cancelRideBtn?.addEventListener('click', () => rideModal.style.display = 'none');
        closeRideModal?.addEventListener('click', () => rideModal.style.display = 'none');
        
        // Navigation event listeners
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);

            setTimeout(() => {
                const firstDayElement = document.querySelector('.date-cell:not(.inactive)');
                if (firstDayElement) {
                    firstDayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);

            setTimeout(() => {
                const firstDayElement = document.querySelector('.date-cell:not(.inactive)');
                if (firstDayElement) {
                    firstDayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        });
        
        // Print button event listener
        printBtn.addEventListener('click', printSchedule);

        // Ride forms and modals
        function openRideModal(dateStr, horseId = null, slot = 'morning') {
            selectedRideDate = dateStr;
            selectedRideDateEl.textContent = formatDisplayDate(dateStr);
            rideModal.dataset.date = dateStr;
            populateHorseSelects();
            if (horseId) rideHorseSelect.value = horseId;
            rideSlotSelect.value = slot;

            // Prefill from override or default
            const override = rideOverrides.find(o => o.date === dateStr && o.horse_id === rideHorseSelect.value && o.slot === slot);
            const day = new Date(dateStr).getDay();
            const defaultRide = rideDefaults.find(d => d.horse_id === rideHorseSelect.value && d.slot === slot && d.day_of_week === day);
            rideRiderInput.value = override?.rider_name || defaultRide?.rider_name || '';
            rideAwayCheckbox.checked = override?.away || false;

            rideModal.style.display = 'block';
        }

        async function saveRideOverride(e) {
            e.preventDefault();
            const date = selectedRideDate;
            const horseId = rideHorseSelect.value;
            const slot = rideSlotSelect.value;
            const rider = rideRiderInput.value.trim();
            const away = rideAwayCheckbox.checked;
            if (!horseId) {
                showSuccessMessage('Välj häst', 'error');
                return;
            }
            const { error } = await supabase
                .from('horse_ride_overrides')
                .upsert([{ date, horse_id: horseId, slot, rider_name: rider, away }], { onConflict: ['date', 'horse_id', 'slot'] });
            if (error) {
                console.error('Error saving ride override', error);
                showSuccessMessage('Kunde inte spara', 'error');
                return;
            }
            rideModal.style.display = 'none';
            fetchRideData();
            showSuccessMessage('Sparat');
        }

        async function deleteRideOverride() {
            const date = selectedRideDate;
            const horseId = rideHorseSelect.value;
            const slot = rideSlotSelect.value;
            const { error } = await supabase
                .from('horse_ride_overrides')
                .delete()
                .eq('date', date)
                .eq('horse_id', horseId)
                .eq('slot', slot);
            if (error) {
                console.error('Error deleting ride override', error);
                showSuccessMessage('Kunde inte ta bort', 'error');
                return;
            }
            rideModal.style.display = 'none';
            fetchRideData();
            showSuccessMessage('Borttagen');
        }
        
        // Initialize the calendar when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            initCalendar();
            fetchSchedule();
            
            // Set current month by default (already showing current week)
            currentMonth = currentDate.getMonth();
            currentYear = currentDate.getFullYear();
            renderCalendar(currentMonth, currentYear);
        });
    </script>
</body>
</html>
